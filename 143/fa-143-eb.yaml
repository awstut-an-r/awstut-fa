AWSTemplateFormatVersion: 2010-09-09
Parameters:
  #ALBSecurityGroup:
  #  Type: String

  #AppSource:
  #  Type: String
    
  BucketName:
    Type: String
    
  EnvironmentType:
    Type: String

  #InstanceSecurityGroup:
  #  Type: String
  
  #InstanceCapacity:
  #  Type: Number
  
  InstanceArchitecture:
    Type: String
    
  #InstanceSecurityGroup:
  #  Type: String
    
  InstanceType:
    Type: String
    
  LoadBalancerType:
    Type: String

  MaxSize:
    Type: Number
    
  MinSize:
    Type: Number

  Prefix:
    Type: String
    
  PrivateSubnet1:
    Type: String
    
  PrivateSubnet2:
    Type: String
    
  PublicSubnet1:
    Type: String
    
  PublicSubnet2:
    Type: String

  SolutionStackName:
    Type: String
    
  SourceBundleName:
    Type: String
    
  VPC:
    Type: String
    
  #WaitCondition:
  #  Type: String


Resources:
  Application:
    Type: AWS::ElasticBeanstalk::Application
    Properties: 
      ApplicationName: !Sub "${Prefix}-application"
      #Description: String
      #ResourceLifecycleConfig: 
      #  ApplicationResourceLifecycleConfig

  ApplicationVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    #DependsOn:
    #  - !Ref 
    Properties: 
      ApplicationName: !Ref Application
      #Description: String
      SourceBundle: 
        S3Bucket: !Ref BucketName
        S3Key: !Ref SourceBundleName
  
  Environment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties: 
      ApplicationName: !Ref Application
      CNAMEPrefix: !Ref Prefix
      #Description: String
      EnvironmentName: !Sub "${Prefix}-env"
      #OperationsRole: String
      #OptionSettings: 
      #  - OptionSetting
      #PlatformArn: !Ref PlatformArn
      #SolutionStackName: !Ref SolutionStackName
      #Tags: 
      #  - Tag
      TemplateName: !Ref ConfigurationTemplate
      Tier: 
        Name: WebServer
        Type: Standard
        #Version: 1.0
      VersionLabel: !Ref ApplicationVersion
  
  ConfigurationTemplate:
    Type: AWS::ElasticBeanstalk::ConfigurationTemplate
    Properties: 
      ApplicationName: !Ref Application
      #Description: String
      #EnvironmentId: !Ref Environment
      OptionSettings: 
        - Namespace: aws:autoscaling:asg
          OptionName: MaxSize
          Value: !Ref MaxSize
        - Namespace: aws:autoscaling:asg
          OptionName: MinSize
          Value: !Ref MinSize
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !Ref InstanceProfile
        #- Namespace: aws:autoscaling:launchconfiguration
        #  OptionName: SecurityGroups
        #  Value: !Ref InstanceSecurityGroup
        - Namespace: aws:ec2:instances
          OptionName: InstanceTypes
          Value: !Ref InstanceType
        - Namespace: aws:ec2:instances
          OptionName: SupportedArchitectures
          Value: !Ref InstanceArchitecture
        - Namespace: aws:ec2:vpc
          OptionName: VPCId
          Value: !Ref VPC
        - Namespace: aws:ec2:vpc
          OptionName: Subnets
          Value: !Join
            - ","
            - - !Ref PrivateSubnet1
              - !Ref PrivateSubnet2
        - Namespace: aws:ec2:vpc
          OptionName: ELBSubnets
          Value: !Join
            - ","
            - - !Ref PublicSubnet1
              - !Ref PublicSubnet2
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: !Ref EnvironmentType
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Sub "arn:aws:iam::${AWS::AccountId}:role/service-role/aws-elasticbeanstalk-service-role"
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: LoadBalancerType
          Value: !Ref LoadBalancerType
        #- Namespace: aws:elbv2:loadbalancer
        #  OptionName: SecurityGroups
        #  Value: !Ref ALBSecurityGroup
      #PlatformArn: String
      SolutionStackName: !Ref SolutionStackName
      #SourceConfiguration: 
      #  SourceConfiguration
      
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref InstanceRole
  
  InstanceRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service:
                - ec2.amazonaws.com
      ManagedPolicyArns:
        #- arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier
        
  #ALBSecurityGroup:
  #  Type: AWS::EC2::SecurityGroup
  #  Properties:
  #    GroupName: !Sub "${Prefix}-ALBSecurityGroup"
  #    GroupDescription: Allow HTTP Only.
  #    VpcId: !Ref VPC
  #    SecurityGroupIngress:
  #      - IpProtocol: tcp
  #        FromPort: 80
  #        ToPort: 80
  #        CidrIp: 0.0.0.0/0
  #       
  #InstanceSecurityGroup:
  #  Type: AWS::EC2::SecurityGroup
  #  Properties:
  #    GroupName: !Sub "${Prefix}-InstanceSecurityGroup"
  #    GroupDescription: Allow HTTP from ALBSecurityGroup.
  #    VpcId: !Ref VPC
  #    SecurityGroupIngress:
  #      - IpProtocol: tcp
  #        FromPort: 80
  #        ToPort: 80
  #        CidrIp: 0.0.0.0/0
  #        #SourceSecurityGroupId: !Ref ALBSecurityGroup