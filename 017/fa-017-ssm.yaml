AWSTemplateFormatVersion: 2010-09-09

Parameters:
  Instance:
    Type: String
    
  #Instance2:
  #  Type: String
    
  MSAD:
    Type: String
    
  #MSADDnsIpAddresses:
  #  #Type: CommaDelimitedList
  #  Type: String
  
  MSADDnsIpAddress1:
    Type: String
    
  MSADDnsIpAddress2:
    Type: String
    
  MSADName:
    Type: String
    
  Prefix:
    Type: String
    
  #SSMLogBucket:
  #  Type: String
    
  WaitForSuccessTimeoutSeconds:
    Type: Number
    

Resources:
  AWSJoinDirectoryServiceDomainAssociation:
    Type: AWS::SSM::Association
    Properties:
      AssociationName: !Sub "${Prefix}-aws-join-directory-service-domain-association"
      Name: AWS-JoinDirectoryServiceDomain
      Parameters:
        directoryId:
          - !Ref MSAD
        directoryName:
          - !Ref MSADName
        dnsIpAddresses:
          #- !Ref MSADDnsIpAddresses
          - !Ref MSADDnsIpAddress1
          - !Ref MSADDnsIpAddress2
      Targets:
        - Key: InstanceIds
          Values:
            - !Ref Instance
            #- !Ref Instance2
      WaitForSuccessTimeoutSeconds: !Ref WaitForSuccessTimeoutSeconds
            
  #AWSRunShellScriptAssociation:
  #  Type: AWS::SSM::Association
  #  DependsOn:
  #    - AWSJoinDirectoryServiceDomainAssociation
  #  Properties:
  #    AssociationName: !Sub "${Prefix}-shellscript-association"
  #    Name: AWS-RunShellScript
  #    Parameters:
  #      commands:
  #        - "Install-WindowsFeature RSAT-ADDS"
  #    Targets:
  #      - Key: InstanceIds
  #        Values:
  #          - !Ref Instance
  #    WaitForSuccessTimeoutSeconds: !Ref WaitForSuccessTimeoutSeconds
      
  AWSRunPowerShellScriptAssociation:
    Type: AWS::SSM::Association
    DependsOn:
      - AWSJoinDirectoryServiceDomainAssociation
    Properties:
      AssociationName: !Sub "${Prefix}-aws-runpowershellscript-association"
      Name: AWS-RunPowerShellScript
      Parameters:
        commands:
          - "Install-WindowsFeature RSAT-ADDS"
      Targets:
        - Key: InstanceIds
          Values:
            - !Ref Instance
      WaitForSuccessTimeoutSeconds: !Ref WaitForSuccessTimeoutSeconds