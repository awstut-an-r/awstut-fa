AWSTemplateFormatVersion: 2010-09-09

Parameters:
  PartitionKey:
    Type: String

  Prefix:
    Type: String
    
  SortKey:
    Type: String
  
  Table:
    Type: String
    
  TopicName:
    Type: String
    
    
Resources:
  TopicRule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: wx_data_ddb
      #Tags: 
      #  - Tag
      TopicRulePayload: 
        Actions: 
          -
            #CloudwatchAlarm: 
            #  CloudwatchAlarmAction
            #CloudwatchLogs: 
            #  CloudwatchLogsAction
            #CloudwatchMetric: 
            #  CloudwatchMetricAction
            DynamoDB: 
              HashKeyField: !Ref PartitionKey
              HashKeyType: NUMBER
              HashKeyValue: ${timestamp()}
              #PayloadField: String
              RangeKeyField: !Ref SortKey
              RangeKeyType: NUMBER
              RangeKeyValue: ${cast(topic(2) AS DECIMAL)}
              RoleArn: !GetAtt TopicRuleRole.Arn
              TableName: !Ref Table
            #DynamoDBv2: 
            #  DynamoDBv2Action
            #Elasticsearch: 
            #  ElasticsearchAction
            #Firehose: 
            #  FirehoseAction
            #Http: 
            #  HttpAction
            #IotAnalytics: 
            #  IotAnalyticsAction
            #IotEvents: 
            #  IotEventsAction
            #IotSiteWise: 
            #  IotSiteWiseAction
            #Kafka: 
            #  KafkaAction
            #Kinesis: 
            #  KinesisAction
            #Lambda: 
            #  LambdaAction
            #Location: 
            #  LocationAction
            #OpenSearch: 
            #  OpenSearchAction
            #Republish: 
            #  #Headers: 
            #  #  RepublishActionHeaders
            #  Qos: 0
            #  RoleArn: !GetAtt TopicRuleRole.Arn
            #  Topic: !Ref DestTopicName
            #S3: 
            #  S3Action
            #Sns: 
            #  MessageFormat: RAW
            #  RoleArn: !GetAtt TopicRuleRole.Arn
            #  TargetArn: !Ref SnsTopicArn
            #Sqs: 
            #  SqsAction
            #StepFunctions: 
            #  StepFunctionsAction
            #Timestream: 
            #  TimestreamAction
        AwsIotSqlVersion: 2016-03-23
        #Description: String
        #ErrorAction: 
        #  Action
        RuleDisabled: false
        #Sql: !Sub "SELECT topic(2) as device_id, temperature FROM '${SourceTopicName}'"
        Sql: !Sub |
          SELECT temperature, humidity, barometer,
            wind.velocity as wind_velocity,
            wind.bearing as wind_bearing,
          FROM '${TopicName}'
        
  TopicRuleRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service:
                - iot.amazonaws.com
      #ManagedPolicyArns:
      #  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: TopicRulePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  #- iot:AttachPolicy
                  #- iot:AttachThingPrincipal
                  #- iot:CreateKeysAndCertificate
                  #- iot:DeleteCertificate
                  #- iot:DescribeEndpoint
                  #- iot:UpdateCertificate
                  - dynamodb:PutItem
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${Table}"
                  #- !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topic/${DestTopicName}"
                  #- "*"