AWSTemplateFormatVersion: 2010-09-09

Parameters:
  #BucketName:
  #  Type: String
  
  CreateImageRoleArn:
    Type: String
    
  #Instance2:
  #  Type: String
    
  Prefix:
    Type: String
    
  TagKey:
    Type: String
    
  TagValue2:
    Type: String
    
  WaitForSuccessTimeoutSeconds:
    Type: Number
    

Resources:
  MaintenanceWindow:
    Type: AWS::SSM::MaintenanceWindow
    Properties: 
      AllowUnassociatedTargets: true
      Cutoff: 1
      Description: My-First-Maintenance-Window
      Duration: 2
      #EndDate: String
      Name: !Sub "${Prefix}-MaintenanceWindow"
      Schedule: rate(15 minutes)
      #ScheduleOffset: Integer
      ScheduleTimezone: Asia/Tokyo
      #StartDate: String
      #Tags: 
      #  - Tag

  MaintenanceWindowTarget:
    Type: AWS::SSM::MaintenanceWindowTarget
    Properties: 
      #Description: My-First-Maintenance-Window-Target
      Name: !Sub "${Prefix}-MaintenanceWindowTarget"
      #OwnerInformation: String
      ResourceType: INSTANCE
      Targets: 
        - Key: !Sub "tag:${TagKey}"
          Values:
            - !Ref TagValue2
      WindowId: !Ref MaintenanceWindow

  MaintenanceWindowTask:
    Type: AWS::SSM::MaintenanceWindowTask
    Properties: 
      #CutoffBehavior: String
      #Description: My-First-Maintenance-Window
      #LoggingInfo: 
      #  LoggingInfo
      MaxConcurrency: 1
      MaxErrors: 1
      Name: !Sub "${Prefix}-MaintenanceWindowTask"
      Priority: 10
      #ServiceRoleArn: String
      Targets: 
        - Key: WindowTargetIds
          Values:
            - !Ref MaintenanceWindowTarget
      TaskArn: AWS-CreateImage
      TaskInvocationParameters: 
        MaintenanceWindowAutomationParameters:
          #DocumentVersion: String
          Parameters:
            AutomationAssumeRole:
              - !Ref CreateImageRoleArn
            InstanceId:
              #- "{{TARGET_ID}}"
              - "{{RESOURCE_ID}}"
            
        #MaintenanceWindowRunCommandParameters:
        #  #CloudWatchOutputConfig: 
        #  #  CloudWatchOutputConfig
        #  #Comment: String
        #  #DocumentHash: String
        #  #DocumentHashType: String
        #  #DocumentVersion: String
        #  #NotificationConfig: 
        #  #  NotificationConfig
        #  OutputS3BucketName: !Ref S3BucketName
        #  #OutputS3KeyPrefix: String
        #  Parameters:
        #    Operation:
        #      - Install
        #  #ServiceRoleArn: String
        #  #TimeoutSeconds: Integer
      #TaskParameters: Json
      TaskType: AUTOMATION
      WindowId: !Ref MaintenanceWindow









  #CreateImageAssociation:
  #  Type: AWS::SSM::Association
  #  Properties:
  #    AssociationName: !Sub "${Prefix}-createimage-association"
  #    AutomationTargetParameterName: InstanceId
  #    Name: AWS-CreateImage
  #    #OutputLocation:
  #    #  S3Location:
  #    #    OutputS3BucketName: !Ref BucketName
  #    #    OutputS3KeyPrefix: !Sub "${Prefix}/createimage-association-log"
  #    Parameters:
  #      AutomationAssumeRole:
  #        #- !GetAtt CreateImageRole1.Arn
  #        - !Ref CreateImageRoleArn
  #      InstanceId:
  #        - "{{RESOURCE_ID}}"
  #        #- !Ref Instance1
  #      #NoReboot:
  #      #  - "false"
  #    Targets:
  #      #- Key: InstanceIds
  #      #  Values:
  #      #    - !Ref Instance1
  #      - Key: !Sub "tag:${TagKey}"
  #        Values:
  #          #- !Ref Instance1
  #          - !Ref TagValue1
  #    WaitForSuccessTimeoutSeconds: !Ref WaitForSuccessTimeoutSeconds
#
  ##CreateImageRole:
  ##  Type: AWS::IAM::Role
  ##  DeletionPolicy: Delete
  ##  Properties:
  ##    AssumeRolePolicyDocument:
  ##      Version: 2012-10-17
  ##      Statement:
  ##        - Effect: Allow
  ##          Action: sts:AssumeRole
  ##          Principal:
  ##            Service:
  ##              - ssm.amazonaws.com
  ##    ManagedPolicyArns:
  ##      - arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole
  ##    #Policies:
  ##    #  - PolicyName: CreateImagePolicy
  ##    #    PolicyDocument:
  ##    #      Version: 2012-10-17
  ##    #      Statement:
  ##    #        - Effect: Allow
  ##    #          Action:
  ##    #            #- "*"
  ##    #            #- ec2:CreateImage
  ##    #            #- ec2:DescribeInstances
  ##    #            - iam:PassRole
  ##    #          Resource:
  ##    #            - "*"