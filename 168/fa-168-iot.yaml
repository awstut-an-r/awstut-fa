AWSTemplateFormatVersion: 2010-09-09

Parameters:
  #ClientName:
  #  Type: String
  
  FunctionArn:
    Type: String
    
  FunctionName:
    Type: String

  Prefix:
    Type: String
    
  #TopicName:
  #  Type: String
    
    
Resources:
  Thing:
    Type: AWS::IoT::Thing
    Properties:
      #AttributePayload: 
      #  Attributes: 
      #    Key: Value
      ThingName: !Sub "${Prefix}-thing"
      
  Authorizer:
    Type: AWS::IoT::Authorizer
    Properties:
      AuthorizerFunctionArn: !Ref FunctionArn
      AuthorizerName: !Sub "${Prefix}-authorizer"
      #EnableCachingForHttp: Boolean
      SigningDisabled: true
      Status: ACTIVE
      #Tags: 
      #  - Tag
      #TokenKeyName: String
      #TokenSigningPublicKeys: 
      #  Key: Value
      
  Permission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FunctionName
      Principal: iot.amazonaws.com
      SourceArn: !GetAtt Authorizer.Arn
      
  #Policy:
  #  Type: AWS::IoT::Policy
  #  #DeletionPolicy: Delete
  #  Properties:
  #    PolicyDocument:
  #      Version: 2012-10-17
  #      Statement:
  #        - Effect: Allow
  #          Action:
  #            - iot:Publish
  #            - iot:Receive
  #          Resource:
  #            - !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topic/${TopicName}"
  #        - Effect: Allow
  #          Action:
  #            - iot:Subscribe
  #          Resource:
  #            - !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topicfilter/${TopicName}"
  #        - Effect: Allow
  #          Action:
  #            - iot:Connect
  #          Resource:
  #            #- !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:client/${ClientName}"
  #            - !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:client/${Thing}"
  #    PolicyName: !Sub "${Prefix}-policy"
  #    #Tags: 
  #    #  - Tag
      
  #PolicyPrincipalAttachment:
  #  Type: AWS::IoT::PolicyPrincipalAttachment
  #  Properties:
  #    PolicyName: !Ref Policy
  #    Principal:
      

Outputs:
  Thing:
    Value: !Ref Thing
    
  #Policy:
  #  Value: !Ref Policy
  
  Authorizer:
    Value: !Ref Authorizer