AWSTemplateFormatVersion: 2010-09-09

Parameters:
  Prefix:
    Type: String
    
  SnsTopicArn:
    Type: String
    
  TopicName:
    Type: String
    
    
Resources:
  TopicRule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: temp_limit_notify
      #Tags: 
      #  - Tag
      TopicRulePayload: 
        Actions: 
          -
            #CloudwatchAlarm: 
            #  CloudwatchAlarmAction
            #CloudwatchLogs: 
            #  CloudwatchLogsAction
            #CloudwatchMetric: 
            #  CloudwatchMetricAction
            #DynamoDB: 
            #  DynamoDBAction
            #DynamoDBv2: 
            #  DynamoDBv2Action
            #Elasticsearch: 
            #  ElasticsearchAction
            #Firehose: 
            #  FirehoseAction
            #Http: 
            #  HttpAction
            #IotAnalytics: 
            #  IotAnalyticsAction
            #IotEvents: 
            #  IotEventsAction
            #IotSiteWise: 
            #  IotSiteWiseAction
            #Kafka: 
            #  KafkaAction
            #Kinesis: 
            #  KinesisAction
            #Lambda: 
            #  LambdaAction
            #Location: 
            #  LocationAction
            #OpenSearch: 
            #  OpenSearchAction
            #Republish: 
            #  #Headers: 
            #  #  RepublishActionHeaders
            #  Qos: 0
            #  RoleArn: !GetAtt TopicRuleRole.Arn
            #  Topic: !Ref DestTopicName
            #S3: 
            #  S3Action
            Sns: 
              MessageFormat: RAW
              RoleArn: !GetAtt TopicRuleRole.Arn
              TargetArn: !Ref SnsTopicArn
            #Sqs: 
            #  SqsAction
            #StepFunctions: 
            #  StepFunctionsAction
            #Timestream: 
            #  TimestreamAction
        AwsIotSqlVersion: 2016-03-23
        #Description: String
        #ErrorAction: 
        #  Action
        RuleDisabled: false
        #Sql: !Sub "SELECT topic(2) as device_id, temperature FROM '${SourceTopicName}'"
        Sql: !Sub |
          SELECT topic(2) as device_id, 
              temperature as reported_temperature, 
              30 as max_temperature 
            FROM '${TopicName}' 
            WHERE temperature > 30
        
  TopicRuleRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service:
                - iot.amazonaws.com
      #ManagedPolicyArns:
      #  - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: TopicRulePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  #- iot:AttachPolicy
                  #- iot:AttachThingPrincipal
                  #- iot:CreateKeysAndCertificate
                  #- iot:DeleteCertificate
                  #- iot:DescribeEndpoint
                  #- iot:UpdateCertificate
                  - sns:Publish
                Resource:
                  - !Ref SnsTopicArn
                  #- !Sub "arn:aws:iot:${AWS::Region}:${AWS::AccountId}:topic/${DestTopicName}"
                  #- "*"