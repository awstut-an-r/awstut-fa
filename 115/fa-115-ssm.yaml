AWSTemplateFormatVersion: 2010-09-09

Parameters:
  AutoScalingGroup:
    Type: String

  #Instance:
  #  Type: String
  
  #Instance1:
  #  Type: String
  #  
  #Instance2:
  #  Type: String
  
  #PatchGroupTag:
  #  Type: String

  Prefix:
    Type: String
    
  #S3BucketName:
  #  Type: String
    
  #WaitForSuccessTimeoutSeconds:
  #  Type: Number


Resources:
  #MyPatchBaseline:
  #  Type: AWS::SSM::PatchBaseline
  #  Properties:
  #    ApprovalRules:
  #      PatchRules:
  #        - ApproveAfterDays: 7
  #          ComplianceLevel: UNSPECIFIED
  #          EnableNonSecurity: false
  #          PatchFilterGroup:
  #            PatchFilters:
  #              - Key: CLASSIFICATION
  #                Values:
  #                  - Security
  #              - Key: SEVERITY
  #                Values:
  #                  - Critical
  #                  #- Important
  #        #- ApproveAfterDays: 7
  #        #  ComplianceLevel: UNSPECIFIED
  #        #  EnableNonSecurity: false
  #        #  PatchFilterGroup:
  #        #    PatchFilters:
  #        #      - Key: CLASSIFICATION
  #        #        Values:
  #        #          - Bugfix
  #    Description: Test Patch Baseline.
  #    Name: !Sub ${Prefix}-MyPatchBaseline
  #    OperatingSystem: AMAZON_LINUX_2
  #    PatchGroups:
  #      - !Sub ${Prefix}-patch-group
        
        
  #AWSRunPatchBaselineAssociation:
  #  Type: AWS::SSM::Association
  #  Properties:
  #    AssociationName: !Sub "${Prefix}-AWSRunPatchBaselineAssociation"
  #    Name: AWS-RunPatchBaseline
  #    OutputLocation:
  #      S3Location:
  #        OutputS3BucketName: !Ref S3BucketName
  #        OutputS3KeyPrefix: !Sub "AWSRunPatchBaselineAssociation"
  #    Parameters:
  #      Operation:
  #        - Install
  #    Targets:
  #      - Key: InstanceIds
  #        Values:
  #          - !Ref Instance
  #          #- !Ref Instance1
  #          #- !Ref Instance2
  #    WaitForSuccessTimeoutSeconds: !Ref WaitForSuccessTimeoutSeconds
      
      
  MaintenanceWindow:
    Type: AWS::SSM::MaintenanceWindow
    Properties: 
      AllowUnassociatedTargets: false
      Cutoff: 1
      #Description: My-First-Maintenance-Window
      Duration: 2
      #EndDate: String
      Name: !Sub "${Prefix}-MaintenanceWindow"
      Schedule: rate(60 minutes)
      #ScheduleOffset: Integer
      ScheduleTimezone: Asia/Tokyo
      #StartDate: String
      #Tags: 
      #  - Tag
      
  MaintenanceWindowTarget:
    Type: AWS::SSM::MaintenanceWindowTarget
    Properties: 
      #Description: My-First-Maintenance-Window-Target
      Name: !Sub "${Prefix}-MaintenanceWindowTarget"
      #OwnerInformation: String
      ResourceType: INSTANCE
      Targets: 
        - Key: tag:aws:autoscaling:groupName
          Values:
            - !Ref AutoScalingGroup
      WindowId: !Ref MaintenanceWindow
      
  MaintenanceWindowTask:
    Type: AWS::SSM::MaintenanceWindowTask
    Properties: 
      #CutoffBehavior: String
      #Description: My-First-Maintenance-Window
      #LoggingInfo: 
      #  LoggingInfo
      MaxConcurrency: 1
      MaxErrors: 0
      Name: !Sub "${Prefix}-MaintenanceWindowTask"
      Priority: 10
      ServiceRoleArn: !GetAtt SSMAutomationRole.Arn
      Targets: 
        - Key: WindowTargetIds
          Values:
            - !Ref MaintenanceWindowTarget
      TaskArn: AWS-PatchAsgInstance
      TaskInvocationParameters: 
        MaintenanceWindowAutomationParameters:
          #DocumentVersion: String
          Parameters:
            InstanceId:
              #- "{{TARGET_ID}}"
              - "{{RESOURCE_ID}}"
            #WaitForReboot:
            #  - "PT0M"
            #WaitForInstance:
            #  - "PT0M"
            #LambdaRoleArn:
            #AutomationAssumeRole:
            #  - !GetAtt SSMAutomationRole.Arn
      
        #MaintenanceWindowRunCommandParameters:
        #  #CloudWatchOutputConfig: 
        #  #  CloudWatchOutputConfig
        #  #Comment: String
        #  #DocumentHash: String
        #  #DocumentHashType: String
        #  #DocumentVersion: String
        #  #NotificationConfig: 
        #  #  NotificationConfig
        #  OutputS3BucketName: !Ref S3BucketName
        #  #OutputS3KeyPrefix: String
        #  Parameters:
        #    Operation:
        #      - Install
        #  #ServiceRoleArn: String
        #  #TimeoutSeconds: Integer
      #TaskParameters: Json
      TaskType: AUTOMATION
      WindowId: !Ref MaintenanceWindow
      
  # https://dev.classmethod.jp/articles/iam-role-for-ssm-automation/
  SSMAutomationRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service:
                - ssm.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole
      Policies:
        - PolicyName: SSMAutomationPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  #- "*"
                  - iam:CreatePolicy
                  - iam:CreateRole
                  - iam:DeletePolicy
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:GetRole
                  - iam:PassRole
                  - iam:PutRolePolicy
                  - lambda:CreateFunction
                  - lambda:DeleteFunction
                  - lambda:GetFunction
                  - lambda:InvokeFunction
                Resource:
                  - "*"