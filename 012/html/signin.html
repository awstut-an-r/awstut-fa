<html>
  <head>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1033.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@5.2.3/dist/amazon-cognito-identity.min.js"></script>
  </head>
  <body>
    <h1>signin.html</h1>
    <p id="name"></p>
    <p id="parameter"></p>
    
    <script type="text/javascript">
      var prefix = 'fa-012';
      var region = 'ap-northeast-1';
      var userPoolId = '[userpool-id]';
      var identityPoolId = '[idpool-id]';
      
      try {
        // get id token.
        var params = new URLSearchParams(location.hash.slice(1));
        var idToken = params.get("id_token");
        
        AWS.config.region = region;
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
          Logins: {
            [`cognito-idp.${region}.amazonaws.com/${userPoolId}`]: idToken
          }
        });
        
        var tokens = idToken.split('.');
        var tokensDecoded = JSON.parse(atob(tokens[1]));
        var name = tokensDecoded.name;
        document.getElementById('name').innerText = `Name: ${name}`;
        
        var ssmParams = {
          Name: `${prefix}-authenticated`
        }
        var ssm = new AWS.SSM();
        ssm.getParameter(ssmParams, function(err, data) {
          if (err) console.log(err, err.stack);
          else {
            var storedParameter = data.Parameter.Value;
            document.getElementById('parameter').innerText = `SSM Parameter Store: ${storedParameter}`;
          }
        });
        
      } catch(e) {
        document.getElementById('name').innerText = 'Name: Guest';
        document.getElementById('parameter').innerText = 'Deny access to SSM Parameter Store.';
      }
    </script>
  </body>
</html>
